<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãã•ã‚‰ãç”ºè­¦å¯Ÿ - ç·åˆæœæŸ»æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="investigation.css">
  <style>
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-container { display: flex; gap: 5px; margin-bottom: -1px; margin-top: 20px; }
    .tab-button {
      background: #e9ecef; border: 1px solid #dee2e6; border-bottom: none;
      padding: 12px 25px; cursor: pointer; font-weight: bold; color: #6c757d;
      border-radius: 8px 8px 0 0; transition: 0.2s;
    }
    .tab-button.active {
      background: #ffffff; color: #2c3e50; border-top: 4px solid #2c3e50;
      padding-top: 9px;
    }
    .main-content {
      border: 1px solid #dee2e6; border-radius: 0 8px 8px 8px;
      padding: 30px; background: #fff; min-height: 500px;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .evidence-slot { display: flex; gap: 10px; margin-bottom: 10px; }
    .testimony-box {
      background: #2c3e50; color: #fff; padding: 20px; border-radius: 8px;
      margin: 20px 0; border-left: 8px solid #e67e22; line-height: 1.8;
    }
    .confession-highlight { color: #f1c40f; font-weight: bold; }
    .no-val { color: #e67e22; font-weight: bold; font-size: 1.1em; }
    
    /* å±¥æ­´ã‚«ãƒ¼ãƒ‰ */
    .int-history-card {
      background: #fff; border: 1px solid #dee2e6; border-left: 6px solid #c0392b;
      border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden;
    }
    .int-history-header { background: #f8f9fa; padding: 10px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    .int-history-body { padding: 15px 20px; }
    .evidence-tag { background: #f1f3f5; border: 1px solid #dcdfe3; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; display: inline-flex; align-items: center; margin-right: 5px; }
    .type-badge { font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-right: 8px; color: #fff; }
    .bg-disclosure { background-color: #2980b9; } 
    .bg-sns { background-color: #27ae60; }        
    .bg-camera { background-color: #8e44ad; }     

    /* ã€è¿½åŠ ã€‘é‹å–¶ç”¨éš ã—ãƒœã‚¿ãƒ³ï¼šã»ã¼é€æ˜ */
    .recovery-btn { opacity: 0.05; cursor: default; background: none; border: none; color: #8b949e; font-size: 10px; transition: 0.3s; vertical-align: middle; margin-left: 10px; }
    .recovery-btn:hover { opacity: 1; cursor: pointer; color: #1f6feb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>æœæŸ»æ”¯æ´ï¼šãã•ã‚‰ãç”ºè­¦å¯Ÿæœ¬éƒ¨ ç·åˆç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h1>
    
    <div class="tab-container">
      <button class="tab-button active" onclick="switchTab('disclosure')">ãƒ—ãƒ­ãƒã‚¤ãƒ€é–‹ç¤ºè«‹æ±‚</button>
      <button class="tab-button" onclick="switchTab('interrogation')">é‡è¦å‚è€ƒäººäº‹æƒ…è´å–</button>
    </div>

    <div class="main-content">
      
      <div id="tab-disclosure" class="tab-content active">
        <div class="status-bar">
          <div class="limit-text">
            ğŸš¨ ç·Šæ€¥é–‹ç¤ºåŸ·è¡Œæ¨©é™ æ®‹æ•°: <span id="limit-count" class="count">5</span> / 5
            <button class="recovery-btn" onclick="recoveryLimit()">[ADMIN_BY_STAFF]</button>
          </div>
        </div>
        <div class="search-panel">
          <span class="panel-title">é–‹ç¤ºç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </span>
          <div class="input-group">
            <input type="text" id="target-handle" placeholder="@handle ã‚’å…¥åŠ›" autocomplete="off">
            <button id="submit-btn" onclick="executeDisclosure()">é–‹ç¤ºå‘½ä»¤é€ä¿¡</button>
          </div>
        </div>
        <div class="section-title">é–‹ç¤ºè«‹æ±‚å±¥æ­´ãƒ­ã‚°</div>
        <div id="history-log"></div>
      </div>

      <div id="tab-interrogation" class="tab-content">
        <div class="search-panel">
          <span class="panel-title">å°‹å•å¯¾è±¡è€…ã®æ°å</span>
          <div class="input-group">
            <input type="text" id="int-target-name" placeholder="æ°åã‚’ãƒ•ãƒ«ãƒãƒ¼ãƒ ã§å…¥åŠ›" autocomplete="off">
          </div>
          <span class="input-hint">â€» åå­—ã¨åå‰ã®é–“ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç©ºã‘ã¦å…¥åŠ›ã—ã¦ãã ã•ã„</span>
        </div>
        <div class="evidence-area" style="background:#f8f9fa; padding:20px; border-radius:8px; border:1px solid #dee2e6;">
          <span class="panel-title">æç¤ºã™ã‚‹è¨¼æ‹ </span>
          <div id="evidence-container"></div>
          <button class="add-secondary-btn" onclick="addEvidenceSlot()">ï¼‹ è¨¼æ‹ ã‚’è¿½åŠ </button>
          <button onclick="executeInterrogation()" style="width:100%; height:50px; background:#c0392b; color:white; border:none; border-radius:8px; font-weight:bold; margin-top:20px; cursor:pointer;">è¨¼æ‹ ã‚’çªãã¤ã‘ã‚‹</button>
        </div>
        <div id="int-output" class="testimony-box">åå‰ã‚’å…¥åŠ›ã—ã€è¨¼æ‹ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
        <div class="section-title">å°‹å•è¨˜éŒ²ï¼ˆå±¥æ­´ï¼‰</div>
        <div id="interrogation-log"></div>
      </div>
    </div>
  </div>

  <script src="disclosureData.js"></script>
  <script src="interrogationData.js"></script>

  <script>
    const ADMIN_KEY = "0204";
    const evTypeMap = { "DISCLOSURE": "é–‹ç¤ºçµæœ", "SNS": "SNSæŠ•ç¨¿", "CAMERA": "ã‚«ãƒ¡ãƒ©ç”»åƒ" };
    
    let disLimit = localStorage.getItem('dis_limit') !== null ? parseInt(localStorage.getItem('dis_limit')) : 4;
    let disHistory = localStorage.getItem('dis_history') ? JSON.parse(localStorage.getItem('dis_history')) : [];
    let intHistory = localStorage.getItem('int_history') ? JSON.parse(localStorage.getItem('int_history')) : [];

    window.onload = () => { updateDisplay(); if(slotCount === 0) addEvidenceSlot(); };

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
    }

    function executeDisclosure() {
      const handle = document.getElementById('target-handle').value.trim();
      if (!handle || disLimit <= 0) return;
      if (disclosureData[handle]) {
        disLimit--;
        const now = new Date();
        const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, "0")}`;
        disHistory.unshift({
          handle: handle,
          no: disclosureData[handle].no,
          name: disclosureData[handle].name,
          address: disclosureData[handle].address,
          info: disclosureData[handle].info,
          time: timeStr
        });
        saveState(); updateDisplay();
        document.getElementById('target-handle').value = "";
      } else { alert("è©²å½“ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"); }
    }

    // ã€è¿½åŠ ã€‘é‹å–¶ç”¨ãƒªã‚«ãƒãƒªãƒ¼æ©Ÿèƒ½ï¼š1å›ãšã¤å¢—ã‚„ã™
    function recoveryLimit() {
      const code = prompt("é‹å–¶ç”¨ãƒªã‚«ãƒãƒªãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š");
      if (code === ADMIN_KEY) {
        disLimit++; // 1å›è¿½åŠ 
        saveState();
        updateDisplay();
        alert("é–‹ç¤ºåŸ·è¡Œæ¨©é™ã‚’ã€1å›ã€‘è¿½åŠ ã—ã¾ã—ãŸã€‚\nç¾åœ¨ã®æ®‹ã‚Š: " + disLimit + "å›");
      } else if (code !== null) {
        alert("ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
      }
    }

    let slotCount = 0;
    function addEvidenceSlot() {
      if (slotCount >= 10) return;
      const container = document.getElementById('evidence-container');
      const div = document.createElement('div');
      div.className = 'evidence-slot';
      div.innerHTML = `
        <select class="ev-type" style="flex:1; padding:10px;">
          <option value="SNS">SNSæŠ•ç¨¿å†…å®¹</option>
          <option value="CAMERA">é˜²çŠ¯ã‚«ãƒ¡ãƒ©ç”»åƒ</option>
          <option value="DISCLOSURE">é–‹ç¤ºè«‹æ±‚çµæœ(No.)</option>
        </select>
        <input type="text" class="ev-code" placeholder="ã‚³ãƒ¼ãƒ‰/No.ã‚’å…¥åŠ›" style="flex:1; padding:10px;">
      `;
      container.appendChild(div); slotCount++;
    }

    function executeInterrogation() {
      const rawName = document.getElementById('int-target-name').value.trim();
      const name = rawName.replace(/ã€€/g, " ").replace(/\s+/g, " "); 
      const slots = document.querySelectorAll('.evidence-slot');
      if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      let presented = Array.from(slots).map(s => {
        const type = s.querySelector('.ev-type').value.toLowerCase();
        const rawCode = s.querySelector('.ev-code').value.trim();
        let code = rawCode.replace(/[ï¼-ï½]/g, str => String.fromCharCode(str.charCodeAt(0) - 0xFEE0)).replace(/[ï¼ãƒ¼â€•]/g, "-").toLowerCase();
        return code ? `${type}_${code}` : null;
      }).filter(v => v !== null);

      if (presented.length === 0) return alert("è¨¼æ‹ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");

      let response = "";
      const person = interrogationData[name];

      if (!person) {
        response = "ã€è¨˜éŒ²ã€‘æœ¬äº‹ä»¶ã¨ã¯ç„¡é–¢ä¿‚ãªäººç‰©ã§ã™ã€‚";
      } else {
        const full = person.responses.find(r => r.type === "FULL" && r.required.every(req => presented.includes(req.toLowerCase())));
        if (full) {
          response = `<span class="confession-highlight">${full.text}</span>`;
        } else {
          const partial = person.responses.filter(r => r.type === "PARTIAL")
                          .sort((a,b) => b.required.length - a.required.length)
                          .find(r => r.required.every(req => presented.includes(req.toLowerCase())));
          response = partial ? partial.text : (person.defaultResponse || "ã€ŒçŸ¥ã‚Šã¾ã›ã‚“ã­ã€‚ã€");
        }
      }

      document.getElementById('int-output').innerHTML = `<strong>${name}:</strong><br>${response}`;
      intHistory.unshift({ name, evidence: presented, response, time: new Date().toLocaleTimeString() });
      saveState(); renderIntHistory();
    }

    function updateDisplay() {
      document.getElementById('limit-count').innerText = disLimit;
      renderDisHistory(); renderIntHistory();
    }

    function saveState() {
      localStorage.setItem('dis_limit', disLimit);
      localStorage.setItem('dis_history', JSON.stringify(disHistory));
      localStorage.setItem('int_history', JSON.stringify(intHistory));
    }

    function renderDisHistory() {
      const log = document.getElementById('history-log');
      if (disHistory.length === 0) { log.innerHTML = '<p style="text-align:center;color:#999;">å±¥æ­´ãªã—</p>'; return; }
      log.innerHTML = disHistory.map(h => `
        <div class="history-card">
          <div class="history-header"><span class="history-handle">SNS: ${h.handle}</span><span class="history-time">${h.time}</span></div>
          <div class="history-body">
            <div class="info-grid">
              <div class="label">ç®¡ç†ç•ªå·</div><div class="val no-val">${h.no}</div>
              <div class="label">æ°å</div><div class="val">${h.name}</div>
              <div class="label">ä½æ‰€</div><div class="val">${h.address}</div>
            </div>
            <div class="memo-section"><span class="memo-title">ğŸ” æœæŸ»ãƒ¡ãƒ¢</span><div class="memo-text">${h.info}</div></div>
          </div>
        </div>
      `).join('');
    }

    function renderIntHistory() {
      const log = document.getElementById('interrogation-log');
      if (intHistory.length === 0) { log.innerHTML = '<p style="text-align:center;color:#999;">å±¥æ­´ãªã—</p>'; return; }
      log.innerHTML = intHistory.map(h => {
        const evidenceHtml = h.evidence.map(ev => {
          const [type, code] = ev.split('_');
          const displayType = evTypeMap[type.toUpperCase()] || type;
          return `<div class="evidence-tag"><span class="type-badge ${type === "disclosure" ? 'bg-disclosure' : type === "sns" ? 'bg-sns' : 'bg-camera'}">${displayType}</span>${code}</div>`;
        }).join('');
        return `<div class="int-history-card">
          <div class="int-history-header"><span style="font-weight:bold;">å°‹å•å¯¾è±¡ï¼š${h.name}</span><span style="font-size:0.85em; color:#999;">${h.time}</span></div>
          <div class="int-history-body"><div style="margin-bottom:10px;">${evidenceHtml}</div><div><strong>è¨¼è¨€:</strong> ${h.response}</div></div>
        </div>`;
      }).join('');
    }
  </script>
</body>
</html>